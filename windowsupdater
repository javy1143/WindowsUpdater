Add-Type -AssemblyName PresentationFramework, PresentationCore, WindowsBase

# --- XAML UI Definition ---
[xml]$xaml = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        Title="PowerShell Update Manager" Height="550" Width="750" WindowStartupLocation="CenterScreen" Background="#F0F0F0">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <TextBlock Text="Available Windows Updates" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>

        <ListView Name="UpdateList" Grid.Row="1" SelectionMode="Extended">
            <ListView.View>
                <GridView>
                    <GridViewColumn Header="Install" Width="50">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected}" HorizontalAlignment="Center"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Title" DisplayMemberBinding="{Binding Title}" Width="450"/>
                    <GridViewColumn Header="Category" DisplayMemberBinding="{Binding Category}" Width="150"/>
                </GridView>
            </ListView.View>
        </ListView>

        <TextBlock Name="StatusLabel" Grid.Row="2" Text="Ready" Foreground="Blue" Margin="0,10,0,0" FontWeight="SemiBold"/>

        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
            <Button Name="BtnRecommend" Content="Recommend" Width="110" Height="30" Margin="5"/>
            <Button Name="BtnSelectAll" Content="Select All" Width="110" Height="30" Margin="5"/>
            <Button Name="BtnInstall" Content="Install Selected" Width="130" Height="30" Margin="5" Background="#FF4CAF50" Foreground="White" FontWeight="Bold"/>
        </StackPanel>
    </Grid>
</Window>
"@

# --- Setup GUI ---
$reader = New-Object System.Xml.XmlNodeReader $xaml
$Window = [Windows.Markup.XamlReader]::Load($reader)

# Sync table to share data between the GUI thread and Background thread
$Sync = [hashtable]::Synchronized(@{
    Window      = $Window
    StatusLabel = $Window.FindName("StatusLabel")
    UpdateList  = $Window.FindName("UpdateList")
    BtnInstall  = $Window.FindName("BtnInstall")
})

# --- Fetch Updates ---
$UpdateSession = New-Object -ComObject Microsoft.Update.Session
$UpdateSearcher = $UpdateSession.CreateUpdateSearcher()
$SearchResult = $UpdateSearcher.Search("IsInstalled=0 and IsHidden=0")
$UpdateCollection = New-Object System.Collections.ObjectModel.ObservableCollection[Object]

foreach ($update in $SearchResult.Updates) {
    $categories = ($update.Categories | Select-Object -ExpandProperty Name) -join ", "
    $UpdateCollection.Add([PSCustomObject]@{ IsSelected = $false; Title = $update.Title; Category = $categories; UpdateObj = $update })
}
$Sync.UpdateList.ItemsSource = $UpdateCollection

# --- Button Logic ---

$Window.FindName("BtnRecommend").Add_Click({
    foreach ($item in $UpdateCollection) { $item.IsSelected = ($item.Category -match "Security|Critical") }
    $Sync.UpdateList.Items.Refresh()
})

$Window.FindName("BtnSelectAll").Add_Click({
    foreach ($item in $UpdateCollection) { $item.IsSelected = $true }
    $Sync.UpdateList.Items.Refresh()
})

$Sync.BtnInstall.Add_Click({
    $Selected = $UpdateCollection | Where-Object { $_.IsSelected -eq $true }
    if ($Selected.Count -eq 0) { return }

    $Sync.BtnInstall.IsEnabled = $false
    
    # Create the background runspace
    $Runspace = [runspacefactory]::CreateRunspace()
    $Runspace.Open()
    $Runspace.SessionStateProxy.SetVariable("Sync", $Sync)
    $Runspace.SessionStateProxy.SetVariable("Selected", $Selected)

    $Powershell = [powershell]::Create().AddScript({
        $Sync.Window.Dispatcher.Invoke([action]{ 
            $Sync.StatusLabel.Text = "Status: Downloading..." 
            $Sync.StatusLabel.Foreground = "Orange"
        })

        $UpdateSession = New-Object -ComObject Microsoft.Update.Session
        $UpdatesToProcess = New-Object -ComObject Microsoft.Update.UpdateColl
        foreach ($s in $Selected) { $UpdatesToProcess.Add($s.UpdateObj) | Out-Null }

        # Download
        $Downloader = $UpdateSession.CreateUpdateDownloader()
        $Downloader.Updates = $UpdatesToProcess
        $Downloader.Download() | Out-Null

        $Sync.Window.Dispatcher.Invoke([action]{ $Sync.StatusLabel.Text = "Status: Installing..." })

        # Install
        $Installer = $UpdateSession.CreateUpdateInstaller()
        $Installer.Updates = $UpdatesToProcess
        $Result = $Installer.Install()

        $Sync.Window.Dispatcher.Invoke([action]{ 
            $Sync.StatusLabel.Text = "Status: Finished. Result Code: $($Result.ResultCode)"
            $Sync.StatusLabel.Foreground = "Green"
            $Sync.BtnInstall.IsEnabled = $true
            [System.Windows.MessageBox]::Show("Installation Finished.")
        })
    })
    
    $Powershell.Runspace = $Runspace
    $Powershell.BeginInvoke() # This runs the code in the background!
})

$Window.ShowDialog() | Out-Null
